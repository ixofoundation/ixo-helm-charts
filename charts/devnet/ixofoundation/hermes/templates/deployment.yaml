apiVersion: apps/v1
kind: Deployment
metadata:
  name: hermes
  labels:
      {{- include "hermes.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: hermes
  template:
    metadata:
      labels:
        app: hermes
    spec:
      containers:
        - name: hermes
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: "{{ .Values.image.pullPolicy }}"
          volumeMounts:
            - name: config
              mountPath: /root/.hermes/config.toml
              subPath: config.toml
            - name: wallet-keys
              mountPath: /root/.hermes/keys
          command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e
              # Iterate over the keys in values.yaml
              for chain in {{ .Values.keys }}; do
                keyName=$(jq -r ".$chain.name" <<< '{{ .Values.keys | toJson }}')
                secretKey=$(jq -r ".$chain.secretKey" <<< '{{ .Values.keys | toJson }}')
                mnemonicFile="/root/.hermes/keys/${secretKey}"

                echo "Adding key for chain: $chain"
                hermes keys add --key-name "$keyName" --chain "$chain" --mnemonic-file "$mnemonicFile"
              done

              # Start Hermes
              hermes start
      volumes:
        - name: config
          configMap:
            name: hermes-config
        - name: wallet-keys
          secret:
            secretName: hermes-wallet-keys